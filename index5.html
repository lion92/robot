<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mini Mario</title>
    <style>
        body { margin: 0; background: #87CEEB; overflow: hidden; }
        canvas { display: block; background: #87CEEB; }
    </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const mario = { x: 100, y: 0, width: 30, height: 50, dx: 0, dy: 0, speed: 4, jumping: false, lives: 5, score: 0 };

    const bullets = [];
    const enemyBullets = [];
    const gravity = 0.5;
    const jumpPower = -11;
    let enemies = [];
    let bombs = [];
    let platforms = [];
    const ground = { x: 0, y: 350, width: 800, height: 50, color: "#228B22" };
    let scrollOffset = 0;
    let backgroundObjects = [];
    let autoPlay = true;
    let enemyShootLimit = 5;

    setInterval(() => {
        enemyShootLimit = 5;
    }, 3000);

    document.addEventListener("keydown", e => { if (e.key.toLowerCase() === "i") autoPlay = !autoPlay; });

    function generateBackground() {
        for (let i = 0; i < 50; i++) {
            backgroundObjects.push({ x: i * 400, y: 50 + Math.random() * 40, width: 80, height: 100, color: "#A9A9A9", layer: 1 });
            backgroundObjects.push({ x: i * 400 + 200, y: 100 + Math.random() * 40, width: 20, height: 50, color: "#654321", layer: 2 });
        }
    }

    function generatePlatforms() {
        for (let i = 0; i < 20; i++) platforms.push({ x: i * 400 + 200, y: 280, width: 100, height: 10, color: "#8B4513" });
        platforms.push({ x: 600, y: 200, width: 80, height: 10, color: "#FFD700" });
    }

    generateBackground();
    generatePlatforms();

    setInterval(() => {
        const cols = 4, spacing = 40, baseX = scrollOffset + canvas.width, baseY = 300;
        for (let c = 0; c < cols; c++) enemies.push({ x: baseX + c * spacing, y: baseY, width: 30, height: 30, color: "green", alive: true, shootCooldown: 0 });
    }, 4000);

    setInterval(() => { if (bombs.length < 10) bombs.push({ x: scrollOffset + Math.random() * canvas.width, y: -20, width: 10, height: 20, speed: 3 }); }, 2000);

    function marioAI() {
        if (!autoPlay) return;

        const nearestEnemy = enemies.filter(e => e.alive).sort((a, b) => Math.abs(a.x - mario.x) - Math.abs(b.x - mario.x))[0];
        if (nearestEnemy) {
            if (nearestEnemy.x > mario.x + 60) mario.dx = mario.speed;
            else if (nearestEnemy.x < mario.x - 60) mario.dx = -mario.speed;
            else mario.dx = 0;

            if (nearestEnemy.x > mario.x && Math.abs(nearestEnemy.y - mario.y) < 50) {
                bullets.push({ x: mario.x + mario.width, y: mario.y + mario.height / 2 - 2, width: 10, height: 4, speed: 6 });
            }
        }

        const dangerBullet = enemyBullets.find(b => {
            const timeToImpact = Math.abs(b.x - mario.x) / b.speed;
            const verticalProximity = Math.abs((b.y + b.height / 2) - (mario.y + mario.height / 2));
            return timeToImpact < 120 && verticalProximity < mario.height;
        });

        const dangerBomb = bombs.find(b => Math.abs(b.x - mario.x) < 120 && b.y > mario.y - 180);

        if (dangerBullet || dangerBomb) {
            if (!mario.jumping) {
                mario.dy = jumpPower;
                mario.jumping = true;
            }
            mario.dx = (dangerBullet && dangerBullet.x < mario.x) ? mario.speed * 3 : -mario.speed * 3;
        }

        if (mario.x < 0) {
            mario.x = 0;
            mario.dx = Math.max(mario.dx, 0);
        }
    }

    function update() {
        marioAI();
        mario.x += mario.dx;
        mario.y += mario.dy;
        mario.dy += gravity;

        if (mario.y + mario.height >= ground.y) {
            mario.y = ground.y - mario.height;
            mario.dy = 0;
            mario.jumping = false;
        }
        platforms.forEach(p => {
            if (mario.x + mario.width > p.x && mario.x < p.x + p.width && mario.y + mario.height >= p.y && mario.y + mario.height <= p.y + 15 && mario.dy >= 0) {
                mario.y = p.y - mario.height;
                mario.dy = 0;
                mario.jumping = false;
            }
        });

        if (mario.x > canvas.width / 2) {
            scrollOffset += mario.dx; mario.x = canvas.width / 2;
            backgroundObjects.forEach(obj => obj.x -= mario.dx * (obj.layer === 1 ? 0.3 : 0.6));
            [...platforms, ...enemies, ...bullets, ...bombs, ...enemyBullets].forEach(e => e.x -= mario.dx);
        }

        bullets.forEach((b, i) => { b.x += b.speed; if (b.x > canvas.width) bullets.splice(i, 1); });
        enemyBullets.forEach((b, i) => { b.x -= b.speed; if (b.x + b.width < 0) enemyBullets.splice(i, 1); });
        bombs.forEach((bomb, i) => { bomb.y += bomb.speed; if (bomb.y > canvas.height) bombs.splice(i, 1); });
        enemies.forEach(enemy => {
            if (!enemy.alive) return;
            enemy.x -= 1;
            bullets.forEach((b, bi) => { if (b.x < enemy.x + enemy.width && b.x + b.width > enemy.x && b.y < enemy.y + enemy.height && b.y + b.height > enemy.y) { enemy.alive = false; bullets.splice(bi, 1); mario.score++; }});
            if (enemy.shootCooldown <= 0 && enemyShootLimit > 0) {
                enemyBullets.push({ x: enemy.x, y: enemy.y + enemy.height / 2, width: 6, height: 3, speed: 3 });
                enemyShootLimit--;
                enemy.shootCooldown = 100 + Math.random() * 100;
            } else enemy.shootCooldown--;
        });
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        backgroundObjects.sort((a, b) => a.layer - b.layer).forEach(obj => { ctx.fillStyle = obj.color; ctx.fillRect(obj.x, obj.y, obj.width, obj.height); });
        ctx.fillStyle = ground.color; ctx.fillRect(ground.x, ground.y, ground.width, ground.height);
        platforms.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.width, p.height); });
        ctx.fillStyle = "red"; ctx.fillRect(mario.x, mario.y, mario.width, mario.height);
        bullets.forEach(b => { ctx.fillStyle = "yellow"; ctx.fillRect(b.x, b.y, b.width, b.height); });
        enemyBullets.forEach(b => { ctx.fillStyle = "purple"; ctx.fillRect(b.x, b.y, b.width, b.height); });
        bombs.forEach(bomb => { ctx.fillStyle = "black"; ctx.fillRect(bomb.x, bomb.y, bomb.width, bomb.height); });
        enemies.forEach(enemy => { if (enemy.alive) { ctx.fillStyle = enemy.color; ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height); } });
        ctx.fillStyle = "black"; ctx.font = "16px Arial"; ctx.fillText(`Vies : ${mario.lives}  Score : ${mario.score}  IA: ${autoPlay ? 'ON' : 'OFF'}`, 10, 20);
    }

    function gameLoop() { requestAnimationFrame(gameLoop); update(); draw(); }
    gameLoop();
</script>
</body>
</html>
